# üìò **ARCHITECTURE.md ‚Äî –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π**

```md
# ARCHITECTURE.md
## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞ Web Messenger (–¥–æ 5000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç **–µ–¥–∏–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É**, –∫–æ—Ç–æ—Ä–æ–π –æ–±—è–∑–∞–Ω—ã —Å–ª–µ–¥–æ–≤–∞—Ç—å:
- Backend Engineer (AI)
- Frontend Engineer (AI)
- –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- –í—Å–µ CI/CD pipelines

---

# 1. –û–±—â–∞—è –∫–æ–Ω—Ü–µ–ø—Ü–∏—è

–ü—Ä–æ–µ–∫—Ç —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –¥–≤—É—Ö –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö —á–∞—Å—Ç–µ–π:

- **Frontend** ‚Äî SPA-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (React + WebSocket + REST)
- **Backend** ‚Äî –º–æ–¥—É–ª—å–Ω—ã–π –º–æ–Ω–æ–ª–∏—Ç FastAPI, –≤–∫–ª—é—á–∞—é—â–∏–π:
  - REST API
  - WebSocket Gateway
  - –ë–∏–∑–Ω–µ—Å-—Å–ª–æ–π
  - –î–æ—Å—Ç—É–ø –∫ –ë–î
  - Celery –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á (email, –º–∏–Ω–∏–∞—Ç—é—Ä—ã)
  - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º —Ñ–∞–π–ª–æ–≤

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–∫, —á—Ç–æ–±—ã:

- –ª–µ–≥–∫–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å  
- –ª–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ Docker  
- –ª–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –¥–æ 5‚Äì10k –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π  
- –Ω–µ –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω—ã–π —Ö–∞–æ—Å  

---

# 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã

## 2.1. –î–≤–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **Frontend** –∂–∏–≤—ë—Ç –≤ `frontend/`
- **Backend** –∂–∏–≤—ë—Ç –≤ `backend/`
- –û–±—â–µ–Ω–∏–µ —Å—Ç—Ä–æ–≥–æ –ø–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É:
  - REST
  - WebSocket
  - MinIO (—á–µ—Ä–µ–∑ presigned URL)

## 2.2. –ß–∏—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ backend (–º–æ–¥—É–ª—å–Ω—ã–π –º–æ–Ω–æ–ª–∏—Ç)
```

/app
/api          ‚Üê –º–∞—Ä—à—Ä—É—Ç—ã HTTP
/ws           ‚Üê WebSocket endpoint + —Ä–æ—É—Ç–µ—Ä
/services     ‚Üê –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
/repositories ‚Üê SQL –∑–∞–ø—Ä–æ—Å—ã –∫ PostgreSQL
/models       ‚Üê SQLAlchemy –º–æ–¥–µ–ª–∏
/schemas      ‚Üê Pydantic
/core         ‚Üê config, security, logger
/workers      ‚Üê Celery –∑–∞–¥–∞—á–∏

````

–ü–æ—è—Å–Ω–µ–Ω–∏–µ:
- API –Ω–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞–µ—Ç –æ –ë–î ‚Üí —Ç–æ–ª—å–∫–æ –≤—ã–∑—ã–≤–∞–µ—Ç —Å–µ—Ä–≤–∏—Å—ã
- –°–µ—Ä–≤–∏—Å—ã –Ω–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞—é—Ç –æ Pydantic ‚Üí —Ç–æ–ª—å–∫–æ –±–∏–∑–Ω–µ—Å –ª–æ–≥–∏–∫–∞
- –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ —Å –º–æ–¥–µ–ª—è–º–∏ SQLAlchemy
- WebSocket –Ω–µ –ø–∏—à–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ –ë–î, –∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ –∂–µ —Å–µ—Ä–≤–∏—Å—ã

---

# 3. –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

### Backend:
- FastAPI (REST + WS)
- PostgreSQL
- SQLAlchemy + Alembic
- Redis (online, ratelimit, –∫–µ—à)
- Celery (—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏)
- MinIO (—Ñ–∞–π–ª—ã)
- Docker Compose
- JWT –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

### Frontend:
- React + Vite
- TypeScript
- Zustand/TanStack Query
- WebSocket –∫–ª–∏–µ–Ω—Ç
- TailwindCSS
- OpenAPI codegen –¥–ª—è HTTP-–∫–ª–∏–µ–Ω—Ç–∞

---

# 4. –†–µ–∞–ª-—Ç–∞–π–º –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### WebSocket:
- –ö–∞–∂–¥—ã–π –∫–ª–∏–µ–Ω—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:  
  `wss://domain/ws?token=JWT`
- Backend –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
- –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤:
  ```python
  connections[user_id] = set[websocket]
````

* –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:

  1. Backend –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ PostgreSQL
  2. –®–ª—ë—Ç ACK –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é
  3. –®–ª—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ WS:

–î–æ 5000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Äî **–æ–¥–∏–Ω instance WS**.
–ü–æ—Å–ª–µ ‚Äî Redis Pub/Sub.

---

# 5. –•—Ä–∞–Ω–∏–ª–∏—â–∞

### PostgreSQL

* –ò—Å—Ç–∏–Ω–∞ –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
* –ò—Å—Ç–∏–Ω–∞ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ—Ñ–∏–ª–µ–π
* –ò–Ω–¥–µ–∫—Å—ã –ø–æ chat_id + created_at
* –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–∑–∂–µ

### Redis

* online/offline —Å—Ç–∞—Ç—É—Å—ã
* rate limit
* –∫–µ—à —á–∞—Ç–æ–≤
* pub/sub (–µ—Å–ª–∏ –º–Ω–æ–≥–æ WS worker)

### MinIO

* —Ñ–∞–π–ª—ã —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å
* frontend –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª—ã –Ω–∞–ø—Ä—è–º—É—é –ø–æ presigned URL

---

# 6. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

* –í—Å–µ HTTPS/WSS
* –í—Å–µ —Ç–æ–∫–µ–Ω—ã ‚Äî JWT
* XSS-–∑–∞—â–∏—Ç–∞ (escape —Ç–µ–∫—Å—Ç–∞)
* Rate limiting
* Permissions –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–∏—Å–æ–≤

---

# 7. –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

## –î–æ 5000 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Äî —Ç–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å:

* 1 API worker
* 1‚Äì2 WS worker
* 1 Celery
* 1 Redis
* 1 PostgreSQL
* 1 MinIO

## –ü–æ—Å–ª–µ 5000:

* WS ‚Üí –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å
* Redis Pub/Sub
* DB —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
* Celery –æ—Ç–¥–µ–ª—å–Ω—ã–º –∫–ª–∞—Å—Ç–µ—Ä–æ–º

---
