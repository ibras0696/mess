# üóíÔ∏è BACKEND.md ‚Äî –∂—É—Ä–Ω–∞–ª –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ backend (–ê–≥–µ–Ω—Ç A)

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: –∫–∞–∂–¥—ã–π –±—ç–∫–µ–Ω–¥-–∞–ø–¥–µ–π—Ç —Ñ–∏–∫—Å–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–º –±–ª–æ–∫–æ–º. –ù–µ —É–¥–∞–ª—è–π –∏—Å—Ç–æ—Ä–∏—é, –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –¥–æ–±–∞–≤–ª—è–π —Å–≤–µ—Ä—Ö—É.

## –ü—Ä–∞–≤–∏–ª–∞ –≤–µ–¥–µ–Ω–∏—è
- –°–ª–µ–¥—É–µ–º ARCHITECTURE.md –∏ API_CONTRACT.md.
- –õ—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ API —Å–Ω–∞—á–∞–ª–∞ –æ—Ç—Ä–∞–∂–∞–µ–º –≤ API_CONTRACT.md, –ø–æ—Ç–æ–º —Ä–µ–∞–ª–∏–∑—É–µ–º.
- –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π API —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º openapi.json.
- –£–∫–∞–∑—ã–≤–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic –∏ –ø—Ä–∞–≤–∫–∏ docker-compose/Makefile, –µ—Å–ª–∏ –±—ã–ª–∏.

## –®–∞–±–ª–æ–Ω –∑–∞–ø–∏—Å–∏ (–∫–æ–ø–∏—Ä—É–π –∏ –∑–∞–ø–æ–ª–Ω—è–π)
```
## YYYY-MM-DD ‚Äî –°–ø—Ä–∏–Ω—Ç N (–∫—Ä–∞—Ç–∫–æ –æ —Ñ–æ–∫—É—Å–µ)
- –°–¥–µ–ª–∞–Ω–æ:
  - ...
- –í —Ä–∞–±–æ—Ç–µ:
  - ...
- –ë–ª–æ–∫–µ—Ä—ã/—Ä–∏—Å–∫–∏:
  - ...
- –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
  - ...
- –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:
  - PR: <—Å—Å—ã–ª–∫–∞ –∏–ª–∏ "-" >
  - API_CONTRACT: –æ–±–Ω–æ–≤–ª—ë–Ω? (–¥–∞/–Ω–µ—Ç)
  - openapi.json: –æ–±–Ω–æ–≤–ª—ë–Ω? (–¥–∞/–Ω–µ—Ç)
  - Alembic –º–∏–≥—Ä–∞—Ü–∏–∏: <–∏–º—è —Ä–µ–≤–∏–∑–∏–∏/–Ω–µ—Ç>
  - docker-compose/Makefile: <—á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å/–Ω–µ—Ç>
```

## –ñ—É—Ä–Ω–∞–ª
*(–Ω–∏–∂–µ –¥–æ–±–∞–≤–ª—è–π –∑–∞–ø–∏—Å–∏ –ø–æ —à–∞–±–ª–æ–Ω—É ‚Äî —Å–≤–µ–∂–∏–µ –≤—ã—à–µ)*

## 2025-12-03 ‚Äî –°–ø—Ä–∏–Ω—Ç 4 (WebSocket)
- –°–¥–µ–ª–∞–Ω–æ:
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω WS endpoint `/ws?token=JWT`: –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ access JWT, –º–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π.
  - –°–æ–±—ã—Ç–∏—è: `send_message` (ACK `message_sent`, broadcast `new_message`), `typing_start/typing_stop` (broadcast `typing`).
  - –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω ChatService; —Å–æ–æ–±—â–µ–Ω–∏—è —Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è –≤ JSON (ISO –¥–∞—Ç—ã).
  - –°–º–æ—É–∫: –ø–æ–¥–Ω—è—Ç —Å—Ç–µ–∫ (–ø–æ—Ä—Ç—ã: DB 5440, Redis 6381, MinIO 9100/9101, Mailhog 1026/8026, backend host 8001 —á–µ—Ä–µ–∑ BACKEND_PORT), –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã, —Å–æ–∑–¥–∞–Ω —á–∞—Ç, –ø—Ä–æ–≤–µ—Ä–µ–Ω WS –æ–±–º–µ–Ω (ACK + broadcast) —á–µ—Ä–µ–∑ websockets lib.
- –í —Ä–∞–±–æ—Ç–µ:
  - –°–ª–µ–¥—É—é—â–∏–π —Å–ø—Ä–∏–Ω—Ç ‚Äî —Ñ–∞–π–ª—ã/attachments + email.
- –ë–ª–æ–∫–µ—Ä—ã/—Ä–∏—Å–∫–∏:
  - Mailhog warning (amd64 –Ω–∞ arm64) –æ—Å—Ç–∞—ë—Ç—Å—è.
  - –ù—É–∂–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å WS –∫–æ–Ω—Ç—Ä–∞–∫—Ç –≤ API_CONTRACT/openapi.
- –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
  - –î–æ–ø–∏—Å–∞—Ç—å WS —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º/email.
- –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:
  - PR: -
  - API_CONTRACT: –æ–±–Ω–æ–≤–ª—ë–Ω? –Ω–µ—Ç
  - openapi.json: –æ–±–Ω–æ–≤–ª—ë–Ω? –Ω–µ—Ç
  - Alembic –º–∏–≥—Ä–∞—Ü–∏–∏: 20251203_init_users, 20251203_add_chats_messages
  - docker-compose/Makefile: –ø–æ—Ä—Ç—ã —Ö–æ—Å—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã (—Å–º. .env.example)

## 2025-12-03 ‚Äî –°–ø—Ä–∏–Ω—Ç 2 (Auth)
- –°–¥–µ–ª–∞–Ω–æ:
  - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω User (SQLAlchemy) + —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, —Å—Ö–µ–º—ã UserCreate/UserRead, JWT-–ø–æ—Ç–æ–∫ (access/refresh).
  - –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã: POST /api/auth/register, /login, /refresh; GET /api/users/me, /api/users/{id}; auth dependency HTTP Bearer.
  - –î–æ–±–∞–≤–ª–µ–Ω—ã security utils (hash/verify, JWT), CORS, DB session.
  - –ù–∞—Å—Ç—Ä–æ–µ–Ω Alembic, –±–∞–∑–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è users, Makefile migrate, env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ TTL —Ç–æ–∫–µ–Ω–æ–≤.
  - –û–±–Ω–æ–≤–ª—ë–Ω backend Dockerfile –¥–ª—è Alembic; requirements (+jose, passlib, email-validator).
- –í —Ä–∞–±–æ—Ç–µ:
  - –°–ª–µ–¥—É—é—â–∏–µ –º–æ–¥–µ–ª–∏/–º–∏–≥—Ä–∞—Ü–∏–∏ (—á–∞—Ç—ã) –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –°–ø—Ä–∏–Ω—Ç 3.
- –ë–ª–æ–∫–µ—Ä—ã/—Ä–∏—Å–∫–∏:
  - Mailhog —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∫–∞–∫ amd64 –Ω–∞ arm64 (warning), –Ω–æ —Å—Ç–∞—Ä—Ç—É–µ—Ç.
- –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
  - –ü–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è ‚Äî –ø–µ—Ä–µ—Ö–æ–¥ –∫ —á–∞—Ç–∞–º (REST).
- –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:
  - PR: -
  - API_CONTRACT: –æ–±–Ω–æ–≤–ª—ë–Ω? –Ω–µ—Ç (auth —Å—Ö–µ–º—É –Ω–µ —É—Ç–æ—á–Ω—è–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ)
  - openapi.json: –æ–±–Ω–æ–≤–ª—ë–Ω? –Ω–µ—Ç
  - Alembic –º–∏–≥—Ä–∞—Ü–∏–∏: 20251203_init_users
  - docker-compose/Makefile: Makefile migrate –æ–±–Ω–æ–≤–ª—ë–Ω; compose –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

## 2025-12-03 ‚Äî –°–ø—Ä–∏–Ω—Ç 3 (REST —á–∞—Ç—ã)
- –°–¥–µ–ª–∞–Ω–æ:
  - –î–æ–±–∞–≤–ª–µ–Ω—ã –º–æ–¥–µ–ª–∏/—Å—Ö–µ–º—ã: Chat, ChatMember, Message; —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏ —Å–µ—Ä–≤–∏—Å—ã.
  - –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã: POST /api/chats (—Å–æ–∑–¥–∞–Ω–∏–µ), GET /api/chats (—Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è), GET /api/chats/{id}/messages (limit/before_id), POST /api/chats/{id}/messages (–æ—Ç–ø—Ä–∞–≤–∫–∞).
  - Alembic –º–∏–≥—Ä–∞—Ü–∏—è `20251203_add_chats_messages`, –æ—Ç–∫–ª—é—á—ë–Ω auto create_all.
  - Docker compose: —Å–º–µ–Ω–∞ –ø–æ—Ä—Ç–æ–≤ –¥–ª—è host map (5433 db, 6380 redis, 9002/9003 minio, 1026/8026 mailhog) —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤.
  - –°–º–æ—É–∫: –ø–æ–¥–Ω—è–ª stack, –ø—Ä–∏–º–µ–Ω–∏–ª –º–∏–≥—Ä–∞—Ü–∏–∏, –∑–∞–≤—ë–ª 2 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–æ–∑–¥–∞–ª —á–∞—Ç, –æ—Ç–ø—Ä–∞–≤–∏–ª/–ø—Ä–æ—á–∏—Ç–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–µ.
- –í —Ä–∞–±–æ—Ç–µ:
  - –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ ‚Äî WebSocket (—Å–ø—Ä–∏–Ω—Ç 4) –ø–æ—Å–ª–µ —Ñ—Ä–æ–Ω—Ç–æ–≤—ã—Ö –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π.
- –ë–ª–æ–∫–µ—Ä—ã/—Ä–∏—Å–∫–∏:
  - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ mailhog amd64 –Ω–∞ arm64 –æ—Å—Ç–∞—ë—Ç—Å—è.
- –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
  - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å WS –≤ —Å–ø—Ä–∏–Ω—Ç–µ 4 (send_message/typing/online).
- –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:
  - PR: -
  - API_CONTRACT: –æ–±–Ω–æ–≤–ª—ë–Ω? –Ω–µ—Ç (REST —á–∞—Ç—ã –±–µ–∑ —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–æ–ª–µ–π –≤ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–µ)
  - openapi.json: –æ–±–Ω–æ–≤–ª—ë–Ω? –Ω–µ—Ç
  - Alembic –º–∏–≥—Ä–∞—Ü–∏–∏: 20251203_init_users, 20251203_add_chats_messages
  - docker-compose/Makefile: compose –ø–æ—Ä—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã

## 2025-12-03 ‚Äî –°–ø—Ä–∏–Ω—Ç 1 (–∏–Ω—Ñ—Ä–∞)
- –°–¥–µ–ª–∞–Ω–æ:
  - –°–æ–±—Ä–∞–ª –∏ –ø–æ–¥–Ω—è–ª —Å—Ç–µ–∫ docker-compose (backend, celery, db, redis, minio, mailhog, —Ñ—Ä–æ–Ω—Ç-–∑–∞–≥–ª—É—à–∫–∞).
  - –ü—Ä–æ–≤–µ—Ä–∏–ª health: `GET /api/healthz` -> 200 {"status":"ok"}, root -> {"app":"web-messenger","env":"local"}.
  - –°—Ç–µ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (`docker compose down`).
- –í —Ä–∞–±–æ—Ç–µ:
  - –û–∂–∏–¥–∞—é –∑–∞–¥–∞—á–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ø—Ä–∏–Ω—Ç–∞.
- –ë–ª–æ–∫–µ—Ä—ã/—Ä–∏—Å–∫–∏:
  - Mailhog —Ç—è–Ω–µ—Ç—Å—è –∫–∞–∫ amd64 –Ω–∞ arm64 (–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ), –Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è.
- –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
  - –ü–µ—Ä–µ–π—Ç–∏ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –°–ø—Ä–∏–Ω—Ç–∞ 2 (auth) –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
- –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:
  - PR: -
  - API_CONTRACT: –æ–±–Ω–æ–≤–ª—ë–Ω? –Ω–µ—Ç
  - openapi.json: –æ–±–Ω–æ–≤–ª—ë–Ω? –Ω–µ—Ç
  - Alembic –º–∏–≥—Ä–∞—Ü–∏–∏: –Ω–µ—Ç
  - docker-compose/Makefile: –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –¥–ª—è –ø–æ–¥—ä—ë–º–∞)
